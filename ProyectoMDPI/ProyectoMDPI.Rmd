---
title: "Análisis Exploratorio del Gasto de los Hogares en Educación (EGHE 2019)"
author:
 - name: Pol Reig i Gómez
   affil: 1
 - name: Clara Montalvá Barcenilla
   affil: 2
 - name: Pablo Carbonell Martínez
   affil: 3
affiliation:
  - num: 1
    address: |
      Máster en Ciencia de Datos
    email: polreig@alumni.uv.es
  - num: 2
    address: |
      Máster en Ciencia de Datos
    email: barcenil@alumni.uv.es
  - num: 3
    address: |
      Máster en Ciencia de Datos
    email: pacarma4@alumni.uv.es
correspondence: |
  Máster en Ciencia de Datos, Universitat de Valencia.
date: "9 de Noviembre de 2025"
# document options
journal: notspecified
type: article
status: submit
# front matter
abstract: |
  El presente proyecto realiza un Análisis Exploratorio de Datos (AED) sobre la Encuesta de Gasto de los Hogares en Educación (EGHE) del año 2019, publicada por el Instituto Nacional de Estadística (INE). El objetivo es entender la estructura del gasto en educación en España, identificando sus principales componentes y las características de los hogares y estudiantes asociados a dicho gasto. Este informe detalla el proceso de importación, limpieza y transformación de los microdatos, seguido de un análisis univariante y bivariante para responder a las preguntas de investigación planteadas.
keywords: AED, Gasto Educación, INE, EGHE 2019.

bibliography: mybibfile.bib
appendix:
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---
```{r,include=FALSE}
# Configuración global
knitr::opts_chunk$set(
  echo = FALSE,           # No mostrar código por defecto
  warning = FALSE,        # Ocultar warnings
  message = FALSE,        # Ocultar mensajes
  fig.align = "center",   # Centrar gráficos
  out.width = "60%",      # Ancho de gráficos
  cache = TRUE            # Cache para chunks pesados
)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
knitr::opts_chunk$set(fig.width = 5, fig.height  = 3.5)
knitr::opts_chunk$set(fig.pos = "H", out.extra = "") # Obligar a que las figuras se muestren en la posición del chunk correspondiente

# Librerías esenciales
library(tidyverse)
library(knitr)
library(kableExtra)
library(summarytools)
library(dplyr)

# Librerías específicas del análisis
library(ggplot2)
library(scales)
library(naniar)
library(patchwork)
```

# Introducción

La educación es ampliamente reconocida como uno de los pilares fundamentales para el desarrollo económico y social de un país. Sin embargo, el acceso y la permanencia en el sistema educativo conllevan una serie de costes directos e indirectos que son asumidos en gran medida por los hogares. Este gasto no se limita únicamente a las tasas y matrículas, sino que abarca un complejo ecosistema de bienes y servicios que incluye desde libros de texto y material escolar hasta servicios de comedor, transporte, actividades extraescolares y clases particulares.

Comprender la magnitud y la composición de este gasto es esencial para evaluar la equidad del sistema educativo y el esfuerzo económico que supone para las familias. El Instituto Nacional de Estadística (INE) proporciona una visión detallada de esta realidad a través de la Encuesta de Gasto de los Hogares en Educación (EGHE).

El presente proyecto tiene como objetivo realizar un Análisis Exploratorio de Datos (AED) sobre los microdatos de la EGHE 2019. Nuestro propósito es diseccionar la estructura del gasto en educación en España, identificando los patrones subyacentes, las diferencias entre distintos tipos de enseñanza y las características de los estudiantes que más gasto generan.

Para guiar nuestro análisis, planteamos las siguientes preguntas de investigación:

1.  **¿Cómo se distribuye la estructura del gasto promedio entre los diferentes tipos de centros (públicos, concertados, privados) y qué factores explican estas diferencias?** Compararemos los patrones de gasto entre los tres regímenes de financiación, analizando no solo las diferencias en el gasto total sino también en su composición (matrículas, servicios complementarios, material).
2.  **¿Qué características del hogar y del estudiante predicen un mayor gasto educativo? ¿Existen diferencias significativas por sexo, composición familiar o tamaño del municipio?** Identificaremos los principales predictores del gasto educativo mediante el análisis de variables demográficas y estructurales. Evaluaremos específicamente si existen brechas de gasto asociadas al sexo del estudiante y el efecto de la composición del hogar.
3.  **¿Cómo evoluciona el gasto educativo total promedio a lo largo del itinerario educativo, desde Infantil hasta la Universidad?** Compararemos el gasto medio en diferentes niveles, como Educación Infantil, Primaria, ESO, Bachillerato y Universidad.
4.  **¿Qué peso real tienen los gastos complementarios (clases particulares, actividades extraescolares, material específico) en el presupuesto total?** Cuantificaremos el impacto de partidas específicas como clases particulares, servicios de comedor, actividades extraescolares y uniformes escolares, que frecuentemente pasan desapercibidos en el debate público sobre el coste de la educación.

Este informe detallará el proceso de limpieza y transformación de los datos, seguido del análisis univariante y bivariante para dar respuesta a estas preguntas, concluyendo con los principales hallazgos de nuestro estudio.

# Carga y Preparación de Datos

El punto de partida de este análisis son los microdatos de la Encuesta de Gasto de los Hogares en Educación (EGHE) del año 2019, proporcionados por el INE. El fichero original, *EGHE_2019.csv*, es un conjunto de datos que, si bien es completo, presenta desafíos significativos para un análisis directo:

- **Codificación de Variables**: Los nombres de las variables (ej. GTT, C01, NEST2) y sus valores (ej. 1, 2, 3) siguen la codificación interna del INE, lo que los hace poco intuitivos.

- **Valores Nulos (NA)**: El dataset utiliza NA (Not Available) de manera ambigua. Un NA en un campo de importe (como importe_comedor) puede significar que el dato se desconoce o, más probablemente, que el estudiante no incurrió en dicho gasto (gasto de 0€).

- **Datos Irrelevantes**: El dataset original contiene numerosas columnas y filas que no son pertinentes para nuestras preguntas de investigación (ej. personas que no son estudiantes, columnas de control de la encuesta). Estos datos o variables son eliminados.

Para abordar estos retos, se ha implementado un proceso de limpieza y transformación estructurado en tres fases, ejecutadas secuencialmente mediante los scripts *limpieza_gastos.R*, *limpieza_hogar.R* y *limpieza_estudiantes.R*.

El **chunk** de código asociado a la limpieza de los datos carga el conjunto de datos crudo y aplica estos tres scripts para generar el dataset limpio (**datos**) que se utilizará en el resto del informe. A continuación, se detallan las transformaciones clave realizadas durante este proceso.


```{r, include=FALSE}
library(dplyr)
# Leemos los datos del dataset EGHE_2019.csv

# Se asignará la lectura a una variable llamada datos, esta será modificada por los archivos de limpieza y dará como salida un dataset limpio
datos <- read.csv("../data/raw/EGHE_2019.csv",sep="\t")

source("../scripts/limpieza_gastos.R")
source("../scripts/limpieza_hogar.R")
source("../scripts/limpieza_estudiantes.R")

```


## Renombrado y Selección de Variables

El primer paso consistió en "traducir" el dataset. Se renombraron todas las variables de interés de sus códigos del INE a nombres descriptivos en español. Por ejemplo: *C01* se renombró a *Tipo_educacion*. Esto fué posible gracias al archivo de descripción del dataset proporcionado por el INE, donde se describe que tipo de nomenclatura se gasta en cada variable y como se codifican los datos.

Paralelamente, se eliminaron columnas innecesarias, variables con porcentajes demasiado elevados de NAs, como las relacionadas con información de becas, para simplificar la estructura del dataset y reducir el ruido.

## Recodificación de Variables Categóricas

Las variables categóricas más importantes fueron transformadas a factores con etiquetas descriptivas para la correcta interpretación y visualización en los análisis.
```{r,echo=FALSE}

ejemplo_recod <- data.frame(
  Variable = c("Tipo_educacion", "SEXO", "Nacionalidad"),
  Código_INE = c("1, 2, 3", "1, 2", "1, 2, 3"),
  Etiqueta = c("Pública, Concertada, Privada", "Hombre, Mujer", "Española, Extranjera, Doble nacionalidad")
)

knitr::kable(ejemplo_recod, caption = "Ejemplos de Recodificación de Variables Categóricas")
```


## Imputación y Tratamiento de Valores Nulos

Partimos de la hipótesis de que, en un campo de gasto, un valor NA significa un gasto de 0€. Posteriormente, se realizó la comprobación de que, para todas las muestras, la suma de todos los tipos de gasto es igual al valor de la variable *gasto_total_educacion*:

$$\sum{\textbf{importes individuales} = \textbf{gasto\_total\_educacion}}$$

Tras comprobar que se cumplía esta condición, se aplicó la siguiente lógica de imputación:

- **Importes (*importe_*)**: Todos los valores NA en columnas de importes (ej. *importe_comedor*, *importe_clases_particulares*) se sustituyeron por 0, indicando un gasto nulo.

- **Servicios (*servicio_*)**: En las variables que indican si se usó un servicio (donde 1=Sí), los NA se imputaron como 2 (el código para "No").

- **Gastos Totales (*gasto_total_*)**: Del mismo modo, los NA en las columnas de gasto total se reemplazaron por 0.

Tras este proceso exhaustivo, el objeto datos queda listo para el análisis. Contiene únicamente las observaciones y variables relevantes, con tipos de datos correctos, sin valores nulos ambiguos y con etiquetas descriptivas.

# Descripción del Conjunto de Datos Limpio: Análisis Univariante

Tras la ejecución de los scripts de limpieza, obtenemos el dataset `datos`. Este conjunto de datos contiene `r nrow(datos)` observaciones (cada una representando a un estudiante que reportó gastos) y `r ncol(datos)` variables limpias y listas para el análisis.

El objetivo de esta sección es realizar un análisis univariante de las variables clave. Este paso es fundamental para entender la distribución y las características de cada variable de forma aislada, antes de buscar relaciones entre ellas. Nos centraremos en la variable objetivo (Gasto Total) y en las principales variables categóricas y numéricas que usaremos para responder a nuestras preguntas.

## Variable Objetivo: Gasto Total Anual (gasto_total_educacion)

Nuestra principal variable de interés es el *gasto_total_educacion* anual por estudiante.

```{r,echo=FALSE}
# Calculamos las estadísticas descriptivas básicas
stats_gasto <- data.frame(
  Metrica = c("Media", "Mediana", "Mínimo", "Máximo", "1er Cuartil", "3er Cuartil", "Desv. Estándar"),
  Valor = c(
    mean(datos$gasto_total_educacion),
    median(datos$gasto_total_educacion),
    min(datos$gasto_total_educacion),
    max(datos$gasto_total_educacion),
    quantile(datos$gasto_total_educacion, 0.25),
    quantile(datos$gasto_total_educacion, 0.75),
    sd(datos$gasto_total_educacion)
  )
)

# Mostramos la tabla formateada
knitr::kable(
  stats_gasto,
  caption = "Estadísticas Descriptivas del Gasto Total Anual por Estudiante",
  digits = 2,
  col.names = c("Métrica", "Valor (€)")
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```

La tabla 2 revela un hallazgo clave: la media (`r round(mean(datos$gasto_total_educacion), 2)` €) es significativamente más alta que la mediana (`r round(median(datos$gasto_total_educacion), 2)` €). Esto indica una distribución asimétrica positiva (sesgada a la derecha).

En la práctica, esto significa que la mayoría de los hogares reportan un gasto relativamente bajo, pero un pequeño número de hogares (probablemente aquellos en centros privados de élite o con altos gastos en actividades complementarias) tienen gastos muy elevados, "inflando" la media hacia arriba. Por esta razón, y tal como se planteaba en nuestras preguntas de investigación, la mediana será una métrica más robusta para describir el gasto del hogar "típico".

El siguiente histograma confirma visualmente esta fuerte asimetría. La gran mayoría de las observaciones se concentran en la parte izquierda del gráfico, con una larga cola de outliers hacia la derecha.

```{r, echo=FALSE, fig.cap="Histograma del Gasto Total Anual (Escala Lineal y Logarítmica).",fig.width=10, out.width="100%"}
# Gráfico Lineal
plot_gasto_linear <- ggplot(datos, aes(x = gasto_total_educacion)) +
  geom_histogram(bins = 50, fill = "dodgerblue4", alpha = 0.7) +
  geom_vline(aes(xintercept = mean(gasto_total_educacion), color = "Media"), linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = median(gasto_total_educacion), color = "Mediana"), linetype = "dotted", size = 1) +
  labs(
    x = "Gasto Total (€) - Escala Lineal",
    y = "Frecuencia (Nº Estudiantes)",
    color = "Estadístico"
  ) +
  scale_color_manual(values = c("Media" = "red", "Mediana" = "black")) +
  scale_x_continuous(labels = scales::dollar_format(suffix = "€", prefix = "")) +
  theme_minimal() +
  theme(legend.position = c(0.8, 0.6)) 

# Gráfico Logarítmico
plot_gasto_log <- ggplot(subset(datos, gasto_total_educacion > 0), aes(x = gasto_total_educacion)) +
  geom_histogram(bins = 40, fill = "dodgerblue4", alpha = 0.7) +
  scale_x_log10(
    labels = scales::dollar_format(suffix = "€", prefix = ""),
    breaks = c(100, 500, 1000, 5000, 10000, 30000) # Breaks manuales para claridad
  ) +
  labs(
    x = "Gasto Total (€) - Escala Log",
    y = NULL # Quitar eje Y para no repetir
  ) +
  theme_minimal()

# Combinar con patchwork
plot_gasto_linear + plot_gasto_log
```

La Figura 1 combina dos vistas de la misma variable:

- El gráfico de la izquierda (escala lineal) nos permite observar la fuerte asimetría positiva y el impacto de los *outliers*, que elevan la media (1638.14 €) muy por encima de la mediana (972 €).

- El gráfico de la derecha (escala logarítmica) complementa al primero. Al comprimir los valores altos y expandir los bajos, nos permite visualizar la forma de la distribución del grueso de los hogares. En esta vista, se puede apreciar mejor dónde se concentran los gastos más comunes.

## Variables Categóricas Principales

A continuación, exploramos la composición de nuestra muestra en función de las variables categóricas clave que guían nuestras preguntas de investigación.

```{r,fig.cap="Nº de Estudiantes por Tipo de Centro y por Nivel Educativo"}
# Gráfico de Tipo de Centro
plot_tipo_centro <- ggplot(datos, aes(x = fct_infreq(Tipo_educacion))) +
  geom_bar(fill = "#0072B2") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  labs( x = "Tipo de Centro", y = "Frecuencia") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))

# Gráfico de Nivel Educativo
# Definimos el orden correcto del itinerario educativo
orden_niveles <- c("Educación Infantil", 
                   "Educación Primaria", 
                   "Educación Secundaria", 
                   "Educación Superior",
                   "Otros estudios sin nivel académico")

niveles_presentes <- intersect(orden_niveles, unique(datos$Nivel_estudios))

plot_nivel <- ggplot(datos, aes(x = Nivel_estudios)) + 
  geom_bar(fill = "#D55E00") +
  scale_x_discrete(limits = niveles_presentes) + # Aplicamos el orden lógico
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  labs( x = "Nivel Educativo", y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))

plot_tipo_centro + plot_nivel
```

De estos gráficos, observamos que:

- **Tipo de Centro**: La mayoría de los estudiantes de la muestra se encuentran en la enseñanza pública, seguida de la concertada y, finalmente, la privada. Esta distribución es coherente con la estructura del sistema educativo español.

- **Nivel Educativo**: La muestra tiene una representación significativa en todas las etapas, con los picos de frecuencia en Educación Primaria y Secundaria.

## Componentes del Gasto (Bienes vs. Servicios)

Las componentes que forman el gasto total son los bienes y los servicios, por eso es interesante identificar cuál de los dos grandes componentes del gasto tiene un mayor peso.

```{r,fig.cap= "Desglose del Gasto Educativo Total"}
# Calculamos el gasto total agregado para cada categoría
total_bienes <- sum(datos$gasto_total_bienes, na.rm = TRUE)
total_servicios <- sum(datos$gasto_total_servicios, na.rm = TRUE)
total_agregado <- total_bienes + total_servicios

# Creamos un dataframe para el gráfico
df_componentes <- data.frame(
  Componente = c("Bienes", "Servicios"),
  Gasto_Total = c(total_bienes, total_servicios)
) %>%
  mutate(
    Porcentaje = Gasto_Total / total_agregado
  )

ggplot(df_componentes, aes(x = "", y = Porcentaje, fill = Componente)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) + # Esto lo convierte en gráfico circular
  geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)),
            position = position_stack(vjust = 0.5)) +
  labs(
    x = NULL, y = NULL
  ) +
  theme_void() +
  theme(legend.position = "bottom")
```

El gráfico circular de la Figura 3 muestra de forma concluyente que, a nivel agregado, el gasto en Servicios (matrículas, comedor, transporte, extraescolares, etc.) representa la mayor parte del desembolso total de los hogares, superando ampliamente al gasto en Bienes (libros, material, uniformes).

## Gastos Complementarios

Finalmente, el análisis debe responder a dos preguntas planteadas inicialmente en la Pregunta 4:

- ¿Qué porcentaje de familias incurre realmente en los gastos complementarios?

- Entre las que sí gastan, ¿cuál es el gasto medio?

```{r gastcomp}
# Función para analizar gastos
analizar_gasto_complementario <- function(gasto_vector, nombre_gasto) {
  
  # % de familias que gastan
  porc_gasta <- mean(gasto_vector > 0, na.rm = TRUE)
  
  # Gasto medio de SOLO los que gastan
  media_los_que_gastan <- mean(gasto_vector[gasto_vector > 0], na.rm = TRUE)
  
  # Gasto medio sobre el TOTAL (incluyendo ceros)
  media_total <- mean(gasto_vector, na.rm = TRUE)
  
  return(
    data.frame(
      Gasto = nombre_gasto,
      Porcentaje_Hogares_con_Gasto = porc_gasta * 100,
      Gasto_Medio_en_quien_paga = media_los_que_gastan,
      Gasto_Medio_sobre_Total = media_total
    )
  )
}

# Aplicamos la función a las variables de interés
df_clases_part <- analizar_gasto_complementario(datos$importe_clases_particulares, "Clases Particulares")
df_comedor <- analizar_gasto_complementario(datos$importe_comedor, "Comedor")
df_extraescolares <- analizar_gasto_complementario(datos$importe_actividades_extraescolares, "Act. Extraescolares")
df_uniformes <- analizar_gasto_complementario(datos$importe_uniformes, "Uniformes")
df_transporte <- analizar_gasto_complementario(datos$importe_transporte, "Transporte")
df_libros <- analizar_gasto_complementario(datos$importe_libros, "Libros de Texto")
df_papeleria <- analizar_gasto_complementario(datos$importe_papeleria, "Papelería")
df_informatica <- analizar_gasto_complementario(datos$importe_productos_informaticos, "Prod. Informáticos")
# Combinamos y mostramos la tabla
tabla_complementarios <- bind_rows(df_clases_part, df_comedor, df_extraescolares, df_transporte,
  df_libros, df_uniformes, df_papeleria, df_informatica)

knitr::kable(
  tabla_complementarios,
  caption = "Análisis de Gastos Complementarios Específicos",
  digits = 2,
  col.names = c("Tipo de Gasto", "% Hogares que pagan", "Gasto Medio (si paga) (€)", "Gasto Medio (Total) (€)")
) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

En la Tabla 3  se observa una clara distinción entre Bienes (materiales) y Servicios:

- Bienes (Alta Frecuencia, Bajo Coste): Existe un grupo de gastos que son casi universales. La 'Papelería' (78.9%) y los 'Libros de Texto' (70.4%) son asumidos por la gran mayoría de los hogares. Sin embargo, su desembolso medio (para quien paga) es de los más bajos, especialmente la papelería (59.04€). Los 'Uniformes' (38.5%) también son un gasto frecuente, pero con un coste medio bajo (109.82€).

- Servicios (Baja Frecuencia, Alto Coste): El patrón se invierte con los servicios, que son menos frecuentes pero suponen un desembolso mucho mayor. El 'Comedor' (22.56%) es el gasto medio más elevado de la tabla (508.14€). Le siguen de cerca las 'Clases Particulares' (18.73%), que suponen 449.11€ de media para quien las contrata.

# Análisis Bivariante del Gasto según las Características de los Estudiantes

Una vez realizado el análisis univariante, se pretende observar las relaciones y los patrones explicativos que influyen en el gasto educativo. Para ello, se emplea el análisis bivariante, cruzando el gasto total de educación y su composición (bienes, servicios reglados o básicos y servicios no reglados o adicionales) con las variables estructurales del sistema educativo.

Este análisis se centra en dos comparaciones fundamentales:

1. Distribución del gasto por tipo de centro. Se compararán los patrones de gasto entre los tres tipos de educación (pública, concertada y privada), analizando no solo las diferencias en el gasto total sino también en la composición de la estructura del gasto. Esto permite determinar cómo el tipo de centro afecta el coste promedio y la inversión en bienes y servicios educativos.

2. Evolución del gasto por nivel educativo. Se examinará cómo el gasto total evoluciona a lo largo de las etapas educativas, desde Infantil hasta la Universidad. Esta comparación del gasto medio en diferentes niveles identifica la intensidad y la carga económica que representa cada etapa para los hogares.


## Composición y promedio del gasto según el tipo de centro
```{r, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
```


```{r, echo=FALSE}
# hacemos el cálculo de medias del gasto en 2 componentes por tipo de centro, agrupamos para sacar las medias y despues desagrupamos para poder hacer la grafica
df_gasto_2comp <- datos %>%
  group_by(Tipo_educacion) %>% summarise(
    Media_bienes = mean(gasto_total_bienes, na.rm = TRUE),
    Media_reglados = mean(gasto_total_servicios_reglados, na.rm = TRUE)) %>% ungroup() %>%
  
  pivot_longer(cols = starts_with("Media_"), names_to = "Componente_gasto", values_to = "Gasto_promedio") %>%

  mutate(Componente_gasto = case_match(Componente_gasto,
    "Media_reglados" ~ "Servicios",
    "Media_bienes" ~ "Bienes"))

# creamos un gráfico de barras apiladas
grafico_gasto_apilado <- ggplot(df_gasto_2comp, aes(x = Tipo_educacion, y = Gasto_promedio, fill = Componente_gasto)) +
  
  # position = "stack" para apilar los componentes
  geom_bar(stat = "identity", position = "stack") + 
  
  scale_fill_brewer(palette="Paired", direction = -1) +
  
  labs(title = "Gasto promedio total según el tipo de centro",
    subtitle = "Desglosado por gastos en bienes y servicios",
    x = "Tipo de centro", y = "Gasto promedio total (€)", fill = "Componente del gasto") +
  
  theme_minimal() +
  theme(legend.position = "bottom", legend.title = element_text(face = "bold"))

print(grafico_gasto_apilado)
```

La gráfica revela una fuerte disparidad en el gasto promedio total entre los tipos de financiación en la educación, siendo la enseñanza privada el coste más elevado superando los 4.500€, seguida por la concertada cercana a 2.000€ y finalmente por la pública alrededor de los 1000€. En los tres casos, el componente dominante es el de servicios (coste como matrícula, cuotas de centro o comedor). No obstante, este gasto es significativamente más alto en la enseñanza privada debido a que estos costes no están subvencionados por el Estado, contrariamente a lo que ocurre en la educación pública y parcielmente en la concertada.

El análisis de la composición demuestra que los bienes, aunque presentes en los tres tipos de centros, representan una proporción relativamente menor del gasto total y no son la causa de las grandes diferencias observadas entre ellos, estableciendo que las familias que optan por la enseñanza privada asumen un coste de servicios muy superior.

## Gasto educativo total promedio por nivel educativo
```{r, echo=FALSE}
library(forcats) 

#escogemos los niveles que vamos a representar
orden_niveles_educativos <- c("Infantil (1er Ciclo)","Infantil (2do Ciclo)", "Primaria", "ESO", "Bachillerato", "Formación Profesional","Universidad")

df_gasto_nivel_agrupado <- datos %>% mutate(Nivel_agrupado = case_when(
    Nivel_estudios_especifico == "1º Ciclo de Educación Infantil" ~ "Infantil (1er Ciclo)",
    Nivel_estudios_especifico == "2º Ciclo de Educación Infantil" ~ "Infantil (2do Ciclo)",
    Nivel_estudios_especifico == "Educación Primaria" ~ "Primaria",
    Nivel_estudios_especifico == "Educación Secundaria Obligatoria (ESO)" ~ "ESO",
    Nivel_estudios_especifico == "Bachillerato" ~ "Bachillerato",
    Nivel_estudios_especifico == "Estudios Universitarios" ~ "Universidad",
    Nivel_estudios_especifico == "Ciclos Formativos de FP" | 
      Nivel_estudios_especifico == "Ciclos Formativos de Grado Superior" ~ "Formación Profesional",
    TRUE ~ NA_character_ )) %>%
  
  #calculamos media
  filter(!is.na(Nivel_agrupado)) %>% group_by(Nivel_agrupado) %>% summarise(Media_Gasto_Total = mean(gasto_total_educacion, na.rm = TRUE), N=n())%>%
  ungroup() %>% mutate(Nivel_agrupado = factor(Nivel_agrupado, levels = orden_niveles_educativos))

grafico_gasto_nivel_total <- ggplot(df_gasto_nivel_agrupado, aes(x = Nivel_agrupado, y = Media_Gasto_Total, fill = Nivel_agrupado)) + geom_bar(stat = "identity") +
  
  scale_fill_manual(values = c(
    "Infantil (1er Ciclo)" = "#1f77b4", "Infantil (2do Ciclo)" = "#ff7f0e", "Primaria" = "#2ca02c", "ESO" = "#d62728", "Bachillerato" = "#9467bd", "Formación Profesional (FP)" = "#8c564b", "Universidad" = "#e377c2")) +
  
  geom_text(aes(label = paste0("€", format(round(Media_Gasto_Total, 0), big.mark = ".", decimal.mark=","))), vjust = -0.5, size = 3.5, color = "black") +

  labs(title = "Gasto educativo total promedio según el nivel de educación",
    x = "Nivel educativo", y = "Gasto promedio total (€)", fill = "Nivel educativo")+
  
  scale_y_continuous(limits = c(0, max(df_gasto_nivel_agrupado$Media_Gasto_Total) * 1.1)) + theme_minimal() + theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))


print(grafico_gasto_nivel_total)
```
La gráfica revela que el gasto educativo promedio aumenta significativamente a lo largo de las etapas académicas. Esta evolución alcanza su punto máximo en la Universidad (€3.056), que es más del doble del gasto en la mayoría de las etapas inferiores, y experimenta su primer gran salto en Bachillerato. En las etapas iniciales, el 1er ciclo de Infantil destaca por ser más caro que las etapas posteriores, lo cual se atribuye a los costes no subvencionados de la etapa 0-3 años. Por otro lado, durante la educación obligatoria, el gasto se mantiene relativamente estable. Las transiciones a Bachillerato y Universidad marcan los puntos críticos donde el coste de tasas, materiales como portátiles y matrículas impacta más fuertemente en el presupuesto familiar.
