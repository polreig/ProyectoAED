---
title: "Análisis Exploratorio del Gasto de los Hogares en Educación (EGHE 2019)"
author:
 - name: Pol Reig i Gómez
   affil: 1
 - name: Clara Montalvá Barcenilla
   affil: 2
 - name: Pablo Carbonell Martínez
   affil: 3
affiliation:
  - num: 1
    address: |
      Máster en Ciencia de Datos
    email: polreig@alumni.uv.es
  - num: 2
    address: |
      Máster en Ciencia de Datos
    email: barcenil@alumni.uv.es
  - num: 3
    address: |
      Máster en Ciencia de Datos
    email: pacarma4@alumni.uv.es
correspondence: |
  Máster en Ciencia de Datos, Universitat de Valencia.
date: "9 de Noviembre de 2025"
# document options
journal: notspecified
type: article
status: submit
# front matter
abstract: |
  El presente proyecto realiza un Análisis Exploratorio de Datos (AED) sobre la Encuesta de Gasto de los Hogares en Educación (EGHE) del año 2019, publicada por el Instituto Nacional de Estadística (INE). El objetivo es entender la estructura del gasto en educación en España, identificando sus principales componentes y las características de los hogares y estudiantes asociados a dicho gasto. Este informe detalla el proceso de importación, limpieza y transformación de los microdatos, seguido de un análisis univariante y bivariante para responder a las preguntas de investigación planteadas.
keywords: AED, Gasto Educación, INE, EGHE 2019.

bibliography: mybibfile.bib
appendix:
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---
```{r,include=FALSE}
# Configuración global
knitr::opts_chunk$set(
  echo = FALSE,           # No mostrar código por defecto
  warning = FALSE,        # Ocultar warnings
  message = FALSE,        # Ocultar mensajes
  fig.align = "center",   # Centrar gráficos
  out.width = "60%",      # Ancho de gráficos
  cache = TRUE            # Cache para chunks pesados
)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
knitr::opts_chunk$set(fig.width = 5, fig.height  = 3.5)
knitr::opts_chunk$set(fig.pos = "H", out.extra = "") # Obligar a que las figuras se muestren en la posición del chunk correspondiente

# Librerías esenciales
library(tidyverse)
library(knitr)
library(kableExtra)
library(summarytools)
library(dplyr)

# Librerías específicas del análisis
library(ggplot2)
library(scales)
library(naniar)
library(patchwork)
```

# Introducción

La educación es ampliamente reconocida como uno de los pilares fundamentales para el desarrollo económico y social de un país. Sin embargo, el acceso y la permanencia en el sistema educativo conllevan una serie de costes directos e indirectos que son asumidos en gran medida por los hogares. Este gasto no se limita únicamente a las tasas y matrículas, sino que abarca un complejo ecosistema de bienes y servicios que incluye desde libros de texto y material escolar hasta servicios de comedor, transporte, actividades extraescolares y clases particulares.

Comprender la magnitud y la composición de este gasto es esencial para evaluar la equidad del sistema educativo y el esfuerzo económico que supone para las familias. El Instituto Nacional de Estadística (INE) proporciona una visión detallada de esta realidad a través de la Encuesta de Gasto de los Hogares en Educación (EGHE).

El presente proyecto tiene como objetivo realizar un Análisis Exploratorio de Datos (AED) sobre los microdatos de la EGHE 2019. Nuestro propósito es diseccionar la estructura del gasto en educación en España, identificando los patrones subyacentes, las diferencias entre distintos tipos de enseñanza y las características de los estudiantes que más gasto generan.

Para guiar nuestro análisis, planteamos las siguientes preguntas de investigación:

1.  **¿Cómo se distribuye la estructura del gasto promedio entre los diferentes tipos de centros (públicos, concertados, privados) y qué factores explican estas diferencias?** Compararemos los patrones de gasto entre los tres regímenes de financiación, analizando no solo las diferencias en el gasto total sino también en su composición (matrículas, servicios complementarios, material).
2.  **¿Qué características del hogar y del estudiante predicen un mayor gasto educativo? ¿Existen diferencias significativas por sexo, composición familiar o tamaño del municipio?** Identificaremos los principales predictores del gasto educativo mediante el análisis de variables demográficas y estructurales. Evaluaremos específicamente si existen brechas de gasto asociadas al sexo del estudiante y el efecto de la composición del hogar.
3.  **¿Cómo evoluciona el gasto educativo total promedio a lo largo del itinerario educativo, desde Infantil hasta la Universidad?** Compararemos el gasto medio en diferentes niveles, como Educación Infantil, Primaria, ESO, Bachillerato y Universidad.
4.  **¿Qué peso real tienen los gastos complementarios (clases particulares, actividades extraescolares, material específico) en el presupuesto total?** Cuantificaremos el impacto de partidas específicas como clases particulares, servicios de comedor, actividades extraescolares y uniformes escolares, que frecuentemente pasan desapercibidos en el debate público sobre el coste de la educación.

Este informe detallará el proceso de limpieza y transformación de los datos, seguido del análisis univariante y bivariante para dar respuesta a estas preguntas, concluyendo con los principales hallazgos de nuestro estudio.

# Carga y Preparación de Datos

El punto de partida de este análisis son los microdatos de la Encuesta de Gasto de los Hogares en Educación (EGHE) del año 2019, proporcionados por el INE. El fichero original, *EGHE_2019.csv*, es un conjunto de datos que, si bien es completo, presenta desafíos significativos para un análisis directo:

- **Codificación de Variables**: Los nombres de las variables (ej. GTT, C01, NEST2) y sus valores (ej. 1, 2, 3) siguen la codificación interna del INE, lo que los hace poco intuitivos.

- **Valores Nulos (NA)**: El dataset utiliza NA (Not Available) de manera ambigua. Un NA en un campo de importe (como importe_comedor) puede significar que el dato se desconoce o, más probablemente, que el estudiante no incurrió en dicho gasto (gasto de 0€).

- **Datos Irrelevantes**: El dataset original contiene numerosas columnas y filas que no son pertinentes para nuestras preguntas de investigación (ej. personas que no son estudiantes, columnas de control de la encuesta). Estos datos o variables son eliminados.

Para abordar estos retos, se ha implementado un proceso de limpieza y transformación estructurado en tres fases, ejecutadas secuencialmente mediante los scripts *limpieza_gastos.R*, *limpieza_hogar.R* y *limpieza_estudiantes.R*.

El **chunk** de código asociado a la limpieza de los datos carga el conjunto de datos crudo y aplica estos tres scripts para generar el dataset limpio (**datos**) que se utilizará en el resto del informe. A continuación, se detallan las transformaciones clave realizadas durante este proceso.


```{r, include=FALSE}
library(dplyr)
# Leemos los datos del dataset EGHE_2019.csv

# Se asignará la lectura a una variable llamada datos, esta será modificada por los archivos de limpieza y dará como salida un dataset limpio
datos <- read.csv("../data/raw/EGHE_2019.csv",sep="\t")

source("../scripts/limpieza_gastos.R")
source("../scripts/limpieza_hogar.R")
source("../scripts/limpieza_estudiantes.R")

```


## Renombrado y Selección de Variables

El primer paso consistió en "traducir" el dataset. Se renombraron todas las variables de interés de sus códigos del INE a nombres descriptivos en español. Por ejemplo: *C01* se renombró a *Tipo_educacion*. Esto fué posible gracias al archivo de descripción del dataset proporcionado por el INE, donde se describe que tipo de nomenclatura se gasta en cada variable y como se codifican los datos.

Paralelamente, se eliminaron columnas innecesarias, variables con porcentajes demasiado elevados de NAs, como las relacionadas con información de becas, para simplificar la estructura del dataset y reducir el ruido.

## Recodificación de Variables Categóricas

Las variables categóricas más importantes fueron transformadas a factores con etiquetas descriptivas para la correcta interpretación y visualización en los análisis.
```{r,echo=FALSE}

ejemplo_recod <- data.frame(
  Variable = c("Tipo_educacion", "SEXO", "Nacionalidad"),
  Código_INE = c("1, 2, 3", "1, 2", "1, 2, 3"),
  Etiqueta = c("Pública, Concertada, Privada", "Hombre, Mujer", "Española, Extranjera, Doble nacionalidad")
)

knitr::kable(ejemplo_recod, caption = "Ejemplos de Recodificación de Variables Categóricas")
```


## Imputación y Tratamiento de Valores Nulos

Partimos de la hipótesis de que, en un campo de gasto, un valor NA significa un gasto de 0€. Posteriormente, se realizó la comprobación de que, para todas las muestras, la suma de todos los tipos de gasto es igual al valor de la variable *gasto_total_educacion*:

$$\sum{\textbf{importes individuales} = \textbf{gasto\_total\_educacion}}$$

Tras comprobar que se cumplía esta condición, se aplicó la siguiente lógica de imputación:

- **Importes (*importe_*)**: Todos los valores NA en columnas de importes (ej. *importe_comedor*, *importe_clases_particulares*) se sustituyeron por 0, indicando un gasto nulo.

- **Servicios (*servicio_*)**: En las variables que indican si se usó un servicio (donde 1=Sí), los NA se imputaron como 2 (el código para "No").

- **Gastos Totales (*gasto_total_*)**: Del mismo modo, los NA en las columnas de gasto total se reemplazaron por 0.

Tras este proceso exhaustivo, el objeto datos queda listo para el análisis. Contiene únicamente las observaciones y variables relevantes, con tipos de datos correctos, sin valores nulos ambiguos y con etiquetas descriptivas.

# Descripción del Conjunto de Datos Limpio: Análisis Univariante

Tras la ejecución de los scripts de limpieza, obtenemos el dataset `datos`. Este conjunto de datos contiene `r nrow(datos)` observaciones (cada una representando a un estudiante que reportó gastos) y `r ncol(datos)` variables limpias y listas para el análisis.

El objetivo de esta sección es realizar un análisis univariante de las variables clave. Este paso es fundamental para entender la distribución y las características de cada variable de forma aislada, antes de buscar relaciones entre ellas. Nos centraremos en la variable objetivo (Gasto Total) y en las principales variables categóricas y numéricas que usaremos para responder a nuestras preguntas.

## Variable Objetivo: Gasto Total Anual (gasto_total_educacion)

Nuestra principal variable de interés es el *gasto_total_educacion* anual por estudiante.

```{r,echo=FALSE}
# Calculamos las estadísticas descriptivas básicas
stats_gasto <- data.frame(
  Metrica = c("Media", "Mediana", "Mínimo", "Máximo", "1er Cuartil", "3er Cuartil", "Desv. Estándar"),
  Valor = c(
    mean(datos$gasto_total_educacion),
    median(datos$gasto_total_educacion),
    min(datos$gasto_total_educacion),
    max(datos$gasto_total_educacion),
    quantile(datos$gasto_total_educacion, 0.25),
    quantile(datos$gasto_total_educacion, 0.75),
    sd(datos$gasto_total_educacion)
  )
)

# Mostramos la tabla formateada
knitr::kable(
  stats_gasto,
  caption = "Estadísticas Descriptivas del Gasto Total Anual por Estudiante",
  digits = 2,
  col.names = c("Métrica", "Valor (€)")
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```

La tabla 2 revela un hallazgo clave: la media (`r round(mean(datos$gasto_total_educacion), 2)` €) es significativamente más alta que la mediana (`r round(median(datos$gasto_total_educacion), 2)` €). Esto indica una distribución asimétrica positiva (sesgada a la derecha).

En la práctica, esto significa que la mayoría de los hogares reportan un gasto relativamente bajo, pero un pequeño número de hogares (probablemente aquellos en centros privados de élite o con altos gastos en actividades complementarias) tienen gastos muy elevados, "inflando" la media hacia arriba. Por esta razón, y tal como se planteaba en nuestras preguntas de investigación, la mediana será una métrica más robusta para describir el gasto del hogar "típico".

El siguiente histograma confirma visualmente esta fuerte asimetría. La gran mayoría de las observaciones se concentran en la parte izquierda del gráfico, con una larga cola de outliers hacia la derecha.

```{r, echo=FALSE, fig.cap="Histograma del Gasto Total Anual (Escala Lineal y Logarítmica).",fig.width=10, out.width="100%"}
# Gráfico Lineal
plot_gasto_linear <- ggplot(datos, aes(x = gasto_total_educacion)) +
  geom_histogram(bins = 50, fill = "dodgerblue4", alpha = 0.7) +
  geom_vline(aes(xintercept = mean(gasto_total_educacion), color = "Media"), linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = median(gasto_total_educacion), color = "Mediana"), linetype = "dotted", size = 1) +
  labs(
    x = "Gasto Total (€) - Escala Lineal",
    y = "Frecuencia (Nº Estudiantes)",
    color = "Estadístico"
  ) +
  scale_color_manual(values = c("Media" = "red", "Mediana" = "black")) +
  scale_x_continuous(labels = scales::dollar_format(suffix = "€", prefix = "")) +
  theme_minimal() +
  theme(legend.position = c(0.8, 0.6)) 

# Gráfico Logarítmico
plot_gasto_log <- ggplot(subset(datos, gasto_total_educacion > 0), aes(x = gasto_total_educacion)) +
  geom_histogram(bins = 40, fill = "dodgerblue4", alpha = 0.7) +
  scale_x_log10(
    labels = scales::dollar_format(suffix = "€", prefix = ""),
    breaks = c(100, 500, 1000, 5000, 10000, 30000) # Breaks manuales para claridad
  ) +
  labs(
    x = "Gasto Total (€) - Escala Log",
    y = NULL # Quitar eje Y para no repetir
  ) +
  theme_minimal()

# Combinar con patchwork
plot_gasto_linear + plot_gasto_log
```

La Figura 1 combina dos vistas de la misma variable:

- El gráfico de la izquierda (escala lineal) nos permite observar la fuerte asimetría positiva y el impacto de los *outliers*, que elevan la media (1638.14 €) muy por encima de la mediana (972 €).

- El gráfico de la derecha (escala logarítmica) complementa al primero. Al comprimir los valores altos y expandir los bajos, nos permite visualizar la forma de la distribución del grueso de los hogares. En esta vista, se puede apreciar mejor dónde se concentran los gastos más comunes.

## Variables Categóricas Principales

A continuación, exploramos la composición de nuestra muestra en función de las variables categóricas clave que guían nuestras preguntas de investigación.

```{r,fig.cap="Nº de Estudiantes por Tipo de Centro y por Nivel Educativo"}
# Gráfico de Tipo de Centro
plot_tipo_centro <- ggplot(datos, aes(x = fct_infreq(Tipo_educacion))) +
  geom_bar(fill = "#0072B2") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  labs( x = "Tipo de Centro", y = "Frecuencia") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))

# Gráfico de Nivel Educativo
# Definimos el orden correcto del itinerario educativo
orden_niveles <- c("Educación Infantil", 
                   "Educación Primaria", 
                   "Educación Secundaria", 
                   "Educación Superior",
                   "Otros estudios sin nivel académico")

niveles_presentes <- intersect(orden_niveles, unique(datos$Nivel_estudios))

plot_nivel <- ggplot(datos, aes(x = Nivel_estudios)) + 
  geom_bar(fill = "#D55E00") +
  scale_x_discrete(limits = niveles_presentes) + # Aplicamos el orden lógico
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  labs( x = "Nivel Educativo", y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))

plot_tipo_centro + plot_nivel
```

De estos gráficos, observamos que:

- **Tipo de Centro**: La mayoría de los estudiantes de la muestra se encuentran en la enseñanza pública, seguida de la concertada y, finalmente, la privada. Esta distribución es coherente con la estructura del sistema educativo español.

- **Nivel Educativo**: La muestra tiene una representación significativa en todas las etapas, con los picos de frecuencia en Educación Primaria y Secundaria.

## Componentes del Gasto (Bienes vs. Servicios)

Las componentes que forman el gasto total son los bienes y los servicios, por eso es interesante identificar cuál de los dos grandes componentes del gasto tiene un mayor peso.

```{r,fig.cap= "Desglose del Gasto Educativo Total"}
# Calculamos el gasto total agregado para cada categoría
total_bienes <- sum(datos$gasto_total_bienes, na.rm = TRUE)
total_servicios <- sum(datos$gasto_total_servicios, na.rm = TRUE)
total_agregado <- total_bienes + total_servicios

# Creamos un dataframe para el gráfico
df_componentes <- data.frame(
  Componente = c("Bienes", "Servicios"),
  Gasto_Total = c(total_bienes, total_servicios)
) %>%
  mutate(
    Porcentaje = Gasto_Total / total_agregado
  )

ggplot(df_componentes, aes(x = "", y = Porcentaje, fill = Componente)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) + # Esto lo convierte en gráfico circular
  geom_text(aes(label = scales::percent(Porcentaje, accuracy = 0.1)),
            position = position_stack(vjust = 0.5)) +
  labs(
    x = NULL, y = NULL
  ) +
  theme_void() +
  theme(legend.position = "bottom")
```

El gráfico circular de la Figura 3 muestra de forma concluyente que, a nivel agregado, el gasto en Servicios (matrículas, comedor, transporte, extraescolares, etc.) representa la mayor parte del desembolso total de los hogares, superando ampliamente al gasto en Bienes (libros, material, uniformes).

## Gastos Complementarios

Finalmente, el análisis debe responder a dos preguntas planteadas inicialmente en la Pregunta 4:

- ¿Qué porcentaje de familias incurre realmente en los gastos complementarios?

- Entre las que sí gastan, ¿cuál es el gasto medio?

```{r gastcomp}
# Función para analizar gastos
analizar_gasto_complementario <- function(gasto_vector, nombre_gasto) {
  
  # % de familias que gastan
  porc_gasta <- mean(gasto_vector > 0, na.rm = TRUE)
  
  # Gasto medio de SOLO los que gastan
  media_los_que_gastan <- mean(gasto_vector[gasto_vector > 0], na.rm = TRUE)
  
  # Gasto medio sobre el TOTAL (incluyendo ceros)
  media_total <- mean(gasto_vector, na.rm = TRUE)
  
  return(
    data.frame(
      Gasto = nombre_gasto,
      Porcentaje_Hogares_con_Gasto = porc_gasta * 100,
      Gasto_Medio_en_quien_paga = media_los_que_gastan
    )
  )
}

# Aplicamos la función a las variables de interés
df_clases_part <- analizar_gasto_complementario(datos$importe_clases_particulares, "Clases Particulares")
df_comedor <- analizar_gasto_complementario(datos$importe_comedor, "Comedor")
df_extraescolares <- analizar_gasto_complementario(datos$importe_actividades_extraescolares, "Act. Extraescolares")
df_uniformes <- analizar_gasto_complementario(datos$importe_uniformes, "Uniformes")
df_transporte <- analizar_gasto_complementario(datos$importe_transporte, "Transporte")
df_libros <- analizar_gasto_complementario(datos$importe_libros, "Libros de Texto")
df_papeleria <- analizar_gasto_complementario(datos$importe_papeleria, "Papelería")
df_informatica <- analizar_gasto_complementario(datos$importe_productos_informaticos, "Prod. Informáticos")
# Combinamos y mostramos la tabla
tabla_complementarios <- bind_rows(df_clases_part, df_comedor, df_extraescolares, df_transporte,
  df_libros, df_uniformes, df_papeleria, df_informatica)

knitr::kable(
  tabla_complementarios,
  caption = "Análisis de Gastos Complementarios Específicos",
  digits = 2,
  col.names = c("Tipo de Gasto", "% Hogares que pagan", "Gasto Medio (si paga) (€)")
) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

En la Tabla 3  se observa una clara distinción entre Bienes (materiales) y Servicios:

- Bienes (Alta Frecuencia, Bajo Coste): Existe un grupo de gastos que son casi universales. La 'Papelería' (78.9%) y los 'Libros de Texto' (70.4%) son asumidos por la gran mayoría de los hogares. Sin embargo, su desembolso medio (para quien paga) es de los más bajos, especialmente la papelería (59.04€). Los 'Uniformes' (38.5%) también son un gasto frecuente, pero con un coste medio bajo (109.82€).

- Servicios (Baja Frecuencia, Alto Coste): El patrón se invierte con los servicios, que son menos frecuentes pero suponen un desembolso mucho mayor. El 'Comedor' (22.56%) es el gasto medio más elevado de la tabla (508.14€). Le siguen de cerca las 'Clases Particulares' (18.73%), que suponen 449.11€ de media para quien las contrata.

# Análisis Bivariante del Gasto según las Características de los Estudiantes

Una vez realizado el análisis univariante, se pretende observar las relaciones y los patrones explicativos que influyen en el gasto educativo. Para ello, se emplea el análisis bivariante, cruzando el gasto total de educación y su composición (bienes, servicios reglados o básicos y servicios no reglados o adicionales) con las variables estructurales del sistema educativo.

Este análisis se centra en dos comparaciones fundamentales:

1. Distribución del gasto por tipo de centro. Se compararán los patrones de gasto entre los tres tipos de educación (pública, concertada y privada), analizando no solo las diferencias en el gasto total sino también en la composición de la estructura del gasto. Esto permite determinar cómo el tipo de centro afecta el coste promedio y la inversión en bienes y servicios educativos.

2. Evolución del gasto por nivel educativo. Se examinará cómo el gasto total evoluciona a lo largo de las etapas educativas, desde Infantil hasta la Universidad. Esta comparación del gasto medio en diferentes niveles identifica la intensidad y la carga económica que representa cada etapa para los hogares.


## Composición y promedio del gasto según el tipo de centro
```{r, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
```


```{r, echo=FALSE, fig.cap= "Gasto educativo promedio desglosado en bienes y servicios según el tipo de centro"}
# hacemos el cálculo de medias del gasto en 2 componentes por tipo de centro, agrupamos para sacar las medias y despues desagrupamos para poder hacer la grafica
df_gasto_2comp <- datos %>%
  group_by(Tipo_educacion) %>% summarise(
    Media_bienes = mean(gasto_total_bienes, na.rm = TRUE),
    Media_reglados = mean(gasto_total_servicios_reglados, na.rm = TRUE)) %>% ungroup() %>%
  
  pivot_longer(cols = starts_with("Media_"), names_to = "Componente_gasto", values_to = "Gasto_promedio") %>%

  mutate(Componente_gasto = case_match(Componente_gasto,
    "Media_reglados" ~ "Servicios",
    "Media_bienes" ~ "Bienes"))

# creamos un gráfico de barras apiladas
grafico_gasto_apilado <- ggplot(df_gasto_2comp, aes(x = Tipo_educacion, y = Gasto_promedio, fill = Componente_gasto)) +
  
  # position = "stack" para apilar los componentes
  geom_bar(stat = "identity", position = "stack") + 
  
  scale_fill_brewer(palette="Paired", direction = -1) +
  
  labs(title = "Gasto promedio total según el tipo de centro",
    subtitle = "Desglosado por gastos en bienes y servicios",
    x = "Tipo de centro", y = "Gasto promedio total (€)", fill = "Componente del gasto") +
  
  theme_minimal() +
  theme(legend.position = "bottom", legend.title = element_text(face = "bold"))

print(grafico_gasto_apilado)
```

La gráfica revela una fuerte disparidad en el gasto promedio total entre los tipos de financiación en la educación, siendo la enseñanza privada el coste más elevado superando los 4.500€, seguida por la concertada cercana a 2.000€ y finalmente por la pública alrededor de los 1000€. En los tres casos, el componente dominante es el de servicios (coste como matrícula, cuotas de centro o comedor). No obstante, este gasto es significativamente más alto en la enseñanza privada debido a que estos costes no están subvencionados por el Estado, contrariamente a lo que ocurre en la educación pública y parcielmente en la concertada.

El análisis de la composición demuestra que los bienes, aunque presentes en los tres tipos de centros, representan una proporción relativamente menor del gasto total y no son la causa de las grandes diferencias observadas entre ellos, estableciendo que las familias que optan por la enseñanza privada asumen un coste de servicios muy superior.

## Gasto educativo total promedio por nivel educativo
```{r, echo=FALSE, fig.cap= "Gasto educativo promedio total según el nivel educativo}
library(forcats) 

#escogemos los niveles que vamos a representar
orden_niveles_educativos <- c("Infantil (1er Ciclo)","Infantil (2do Ciclo)", "Primaria", "ESO", "Bachillerato", "Formación Profesional","Universidad")

df_gasto_nivel_agrupado <- datos %>% mutate(Nivel_agrupado = case_when(
    Nivel_estudios_especifico == "1º Ciclo de Educación Infantil" ~ "Infantil (1er Ciclo)",
    Nivel_estudios_especifico == "2º Ciclo de Educación Infantil" ~ "Infantil (2do Ciclo)",
    Nivel_estudios_especifico == "Educación Primaria" ~ "Primaria",
    Nivel_estudios_especifico == "Educación Secundaria Obligatoria (ESO)" ~ "ESO",
    Nivel_estudios_especifico == "Bachillerato" ~ "Bachillerato",
    Nivel_estudios_especifico == "Estudios Universitarios" ~ "Universidad",
    Nivel_estudios_especifico == "Ciclos Formativos de FP" | 
      Nivel_estudios_especifico == "Ciclos Formativos de Grado Superior" ~ "Formación Profesional",
    TRUE ~ NA_character_ )) %>%
  
  #calculamos media
  filter(!is.na(Nivel_agrupado)) %>% group_by(Nivel_agrupado) %>% summarise(Media_Gasto_Total = mean(gasto_total_educacion, na.rm = TRUE), N=n())%>%
  ungroup() %>% mutate(Nivel_agrupado = factor(Nivel_agrupado, levels = orden_niveles_educativos))

grafico_gasto_nivel_total <- ggplot(df_gasto_nivel_agrupado, aes(x = Nivel_agrupado, y = Media_Gasto_Total, fill = Nivel_agrupado)) + geom_bar(stat = "identity") +
  
  scale_fill_manual(values = c(
    "Infantil (1er Ciclo)" = "#1f77b4", "Infantil (2do Ciclo)" = "#ff7f0e", "Primaria" = "#2ca02c", "ESO" = "#d62728", "Bachillerato" = "#9467bd", "Formación Profesional (FP)" = "#8c564b", "Universidad" = "#e377c2")) +
  
  geom_text(aes(label = paste0("€", format(round(Media_Gasto_Total, 0), big.mark = ".", decimal.mark=","))), vjust = -0.5, size = 3.5, color = "black") +

  labs(title = "Gasto educativo total promedio según el nivel de educación",
    x = "Nivel educativo", y = "Gasto promedio total (€)", fill = "Nivel educativo")+
  
  scale_y_continuous(limits = c(0, max(df_gasto_nivel_agrupado$Media_Gasto_Total) * 1.1)) + theme_minimal() + theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))


print(grafico_gasto_nivel_total)
```
La gráfica revela que el gasto educativo promedio aumenta significativamente a lo largo de las etapas académicas. Esta evolución alcanza su punto máximo en la Universidad (€3.056), que es más del doble del gasto en la mayoría de las etapas inferiores, y experimenta su primer gran salto en Bachillerato. En las etapas iniciales, el 1er ciclo de Infantil destaca por ser más caro que las etapas posteriores, lo cual se atribuye a los costes no subvencionados de la etapa 0-3 años. Por otro lado, durante la educación obligatoria, el gasto se mantiene relativamente estable. Las transiciones a Bachillerato y Universidad marcan los puntos críticos donde el coste de tasas, materiales como portátiles y matrículas impacta más fuertemente en el presupuesto familiar.

# Análisis bivariante de los gastos respecto las características del hogar

Continuando con el análisis bivariante, y tras haber examinado la influencia de las características propias del estudiante, este apartado se centra en las variables estructurales del hogar que condicionan el gasto. Para ello, analizamos la dependencia del gasto total del hogar y su composición (educación, bienes, servicios reglados y no reglados) con dos variables clave del hogar: el tamaño de su municipio y la composición de sus miembros.

1. Gasto del hogar por tamaño del municipio (TMUNI). Se compararán los patrones de gasto mediano entre los diferentes tamaños de municipio (desde "<10.000 habitantes" hasta ">500.000 habitantes"). El objetivo es determinar si la magnitud de la población del municipio se relaciona con el gasto promedio del hogar, tanto en su totalidad como en su composición específica. Para ello, se emplearán diagramas de caja (geom_boxplot) y la prueba de correlación de Spearman, dado el carácter ordinal de la variable TMUNI.

2. Gasto del hogar por proporción de estudiantes. Se examinará cómo evoluciona el gasto total a medida que la "densidad" de estudiantes en el hogar (la proporción EHOGAR / NHOGAR) aumenta. Esta variable numérica se ha categorizado en 5 intervalos (0-20%, 21-40%, etc.) para facilitar la comparación. Esta comparación del gasto mediano (mediante boxplots y correlación de Spearman) medirá la fuerza de la tendencia respecto la carga económica que representan los estudiantes para los hogares.

3. Gasto por localización del centro de estudios. Finalmente, se analizará la dependencia del gasto con la localización del centro. Aunque esta es una característica del estudiante (nivel de persona) y no del hogar, su impacto económico es fundamental. Se compararán los patrones de gasto mediano (mediante diagramas de barras) para determinar si la distancia al centro supone una brecha económica significativa.

## Relación del gasto del hogar con el tamaño del municipio.
```{r, echo=FALSE}
#### Primero seleccionamos las variables que nos interesan de nuestro dataset original
datos_hogar <- datos %>%
  group_by(IDHOGAR) %>%
  summarise(TMUNI = first(TMUNI), NHOGAR = first(NHOGAR), EHOGAR = first(EHOGAR), Prop_Estudia = (EHOGAR/NHOGAR)*100, H_Gasto_Educación = sum(gasto_total_educacion), H_Gasto_Servicios_Reglados = sum(gasto_total_servicios_reglados), H_Gasto_Servicios_NoReglados = sum(gasto_total_servicios_no_reglados), H_Gasto_Bienes = sum(gasto_total_bienes)) 

datos_hogar$Prop_Estudia <- signif(datos_hogar$Prop_Estudia, digits = 4)
```

```{r, echo=FALSE}
#### Segundo sacamos los datos relacionados con el municipio y el gasto.
datos_muni <- datos_hogar %>%
  select(IDHOGAR, TMUNI, H_Gasto_Educación, H_Gasto_Servicios_Reglados, H_Gasto_Servicios_NoReglados, H_Gasto_Bienes) %>%
  pivot_longer(cols = starts_with("H_Gasto_"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto", names_prefix = "H_Gasto_")

```

```{r, echo=FALSE, fig.width=5, fig.height=3, fig.cap= "Relación entre gastos del hogar y tamaño del municipio"}
#### Ahora representamos una serie de gráficas de diagramas de caja de cada tamaño de municipio. Cada gráfica corresponde a una pieza del gasto total del hogar. Los gastos los representamos el escala logarítmica para mejorar la visualización.

datos_muni %>% ggplot(aes(x = TMUNI, y = log(Valor_Gasto +1))) + 
  geom_boxplot(aes(fill = TMUNI), show.legend = FALSE, outlier.color = "red") +
  facet_wrap(~Tipo_Gasto, scales = "free_x", ncol = 2) +
  coord_flip() +
  labs(title = "Relación Gastos Hogar y Tamaño del Municipio", x = "Tamaño del Municipio", y = "Log(Gasto Total Hogar (€) +1)") +
  theme_minimal()
```
```{r, echo=FALSE}
#### Calculamos cual es la máxima mediana 

Medianas_gasto_TMUNI <- datos_muni %>% 
  group_by(TMUNI, Tipo_Gasto) %>%
  summarise(Mediana_Gasto = median(Valor_Gasto, na.rm = TRUE), .groups = "drop")

max_mediana_TMUNI <- Medianas_gasto_TMUNI %>%
  group_by(TMUNI) %>%
  slice_max(order_by = Mediana_Gasto, n = 1) %>%
  ungroup()

```

```{r, echo=FALSE}
#### Sumamos todas las componentes del gasto y calculamos la correlación con el tamaño del municipio.

Gasto_Total_TMUNI <- datos_muni %>%
  group_by(IDHOGAR, TMUNI) %>%
  summarise(GastoTotal = sum(Valor_Gasto), .groups = "drop") 
  
cor_gasto_tmuni <- cor.test(as.numeric(Gasto_Total_TMUNI$TMUNI),Gasto_Total_TMUNI$GastoTotal, method = "spearman", exact = FALSE)

rho <- cor_gasto_tmuni$estimate
p <- cor_gasto_tmuni$p.value

```


Para analizar la relación entre el gasto del hogar y el Tamaño del Municipio (TMUNI), fue necesario abordar primero la naturaleza de los datos. Las variables de gasto presentan una fuerte asimetría (sesgo a la derecha) y la presencia de numerosos valores cero (0€), lo cual es evidente en la alta concentración de outliers. Para manejar esto y permitir una visualización válida de las tendencias, se aplica una transformación logarítmica (log(Gasto + 1)) a todas las variables de gasto. Esta técnica robustece el análisis al comprimir la escala y mantener los valores cero en el gráfico como log(1)=0.

El análisis visual (mostrado en el gráfico) confirma la hipótesis de que el gasto aumenta con el tamaño del municipio. Los diagramas de caja (geom_boxplot) revelan una clara tendencia positiva: la mediana del gasto (la línea central de la caja) se desplaza sistemáticamente hacia la derecha (mayor gasto) a medida que el municipio es más grande.

Esta observación visual ha sido validada estadísticamente mediante una Correlación de Spearman (cor.test), método robusto que mide la fuerza de una tendencia monótona y es adecuado para variables ordinales como TMUNI.

Los resultados de esta prueba son concluyentes. Se obtuvo un p-value de 2.346e-12, un valor drásticamente inferior al umbral de significación de 0.05, por lo que se rechaza la hipótesis nula. Esto confirma que la relación es estadísticamente significativa. En cuanto a la fuerza y dirección, se obtuvo un coeficiente rho de 0.137. Este valor indica una correlación positiva débil; si bien la relación es estadísticamente real, el tamaño del municipio es solo uno de los factores que influyen en el gasto total del hogar.


## Relación entre el gasto y el porcentaje de estudiantes en el hogar

```{r, echo=FALSE}
#### Primero seleccionamos las variables que nos interesan y categorizamos la proporción de estudiantes para facilitar nuestro estudio.

datos_hogar_porcentaje <- datos_hogar %>%
  select(IDHOGAR, Prop_Estudia, H_Gasto_Educación, H_Gasto_Servicios_Reglados, H_Gasto_Servicios_NoReglados, H_Gasto_Bienes) %>%
  mutate(Grupo_Proporción = cut(Prop_Estudia, breaks= c(-0.1, 20, 40, 60, 80, 100), labels = c("0-20%", "21-40%", "41-60%", "61-80%", "81-100%"), include.lowest = TRUE)) %>%
  pivot_longer(cols = starts_with("H_Gasto_"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto", names_prefix = "H_Gasto_")  
  
```


```{r, echo=FALSE,fig.width=5, fig.height=3, fig.cap= "Gastos del hogar por proporción de esudiantes"}
#### Representamos gráficamente

datos_hogar_porcentaje %>% ggplot(aes(x = Grupo_Proporción, y = log(Valor_Gasto+1))) +
  geom_boxplot(aes(fill = Grupo_Proporción), show.legend = FALSE, outlier.colour = "red") + 
  facet_wrap(~Tipo_Gasto, scales="free_x", ncol = 2) +
  coord_flip() +
  labs(title = "Gastos Hogar (Log) por Prop. Estudiantes ", x = "Grupo de Proporción de Estudiantes", y = "Log(Gasto Total del Hogar (€) + 1)") 
  
```
```{r, echo=FALSE}
#### Calculamos cual es la máxima mediana

Medianas_gasto <- datos_hogar_porcentaje %>%
  group_by(Grupo_Proporción, Tipo_Gasto) %>%
  summarise(Mediana_Gasto = median(Valor_Gasto), .groups = "drop")

max_mediana <- Medianas_gasto %>%
  group_by(Grupo_Proporción) %>%
  slice_max(order_by = Mediana_Gasto, n=1) %>%
  ungroup()
```

```{r, echo=FALSE}
#### Estudiamos la correlación de las variables
Gasto_Total_PropEst <- datos_hogar_porcentaje %>%
  group_by(IDHOGAR, Grupo_Proporción) %>%
  summarise(Gasto_Total = sum(Valor_Gasto), .groups = "drop") 
  
cor_gasto_prop <- cor.test(as.numeric(Gasto_Total_PropEst$Grupo_Proporción), Gasto_Total_PropEst$Gasto_Total, method = "spearman", exact = FALSE)

rho <- cor_gasto_prop$estimate
p <- cor_gasto_prop$p.value

```


Para analizar cómo el gasto se ve afectado por la "densidad" de estudiantes, la variable Prop_Estudia se categorizó en cinco intervalos ordinales de 20% (de "0-20%" a "81-100%"). Al igual que en el análisis anterior, se aplica la transformación logarítmica (log(Gasto + 1)) a las variables de gasto para gestionar la fuerte asimetría y la presencia de valores cero (0€).

El análisis visual confirma que el gasto mediano (la línea central de la caja) es significativamente diferente entre los grupos. Sin embargo, el análisis numérico (ver image_1c01f3.png) revela un detalle clave: la tendencia no es perfectamente lineal. El gasto mediano alcanza su pico en el grupo '61-80%' (2330.5€), siendo este ligeramente superior al del grupo '81-100%' (2175.0€). Este hallazgo sugiere que el gasto máximo no lo definen los hogares compuestos 100% por estudiantes (posiblemente pisos compartidos con gastos optimizados), sino las familias tradicionales que financian simultáneamente las etapas educativas más caras (ej. Bachillerato y Universidad).

Esta tendencia general creciente ha sido validada estadísticamente mediante una Correlación de Spearman. Los resultados muestran un coeficiente rho positivo de 0.274. Este valor indica una correlación positiva de fuerza moderada, la cual es altamente significativa según el p-value de 5.319e-46. Al ser el p-value drásticamente inferior a 0.05, se rechaza la hipótesis nula, confirmando que la tendencia es real.

En resumen, la evidencia confirma una tendencia significativa y positiva: a mayor proporción de estudiantes, mayor es el gasto total mediano, alcanzando su máximo en los hogares con una proporción de estudiantes del 61-80%.


## Relación de gasto con localización del centro escolar

```{r, echo=FALSE}
#### Seleccionamos las variables que nos interesan y creamos una nueva columna con la mediana de la suma total de los gastos

Medianas_gasto_loc <- datos %>%
  select(Localización_Centro, gasto_total_educacion, gasto_total_servicios_reglados, gasto_total_servicios_no_reglados, gasto_total_bienes) %>%
  mutate(Gasto_Total = gasto_total_educacion + gasto_total_servicios_reglados + gasto_total_servicios_no_reglados + gasto_total_bienes) %>%
  group_by(Localización_Centro) %>%
  summarise(Mediana_gasto_total = median(Gasto_Total))
```

```{r, echo=FALSE,fig.width=5, fig.height=3, fig.cap= "Mediana del gasto total por localización del centro"}
Medianas_gasto_loc %>% ggplot(aes(x = reorder(Localización_Centro, Mediana_gasto_total), y = Mediana_gasto_total)) +
  geom_col(aes(fill = Localización_Centro), show.legend = FALSE) +
  geom_text(aes(label = round(Mediana_gasto_total, 0)), hjust = -0.2, size = 3.5) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = "Mediana del Gasto Total por Localización del Centro", x = "Localización del Centro", y = "Mediana del Gasto Total de la Persona (€)"
  ) +
  theme_minimal()
```


El análisis bivariante del gasto total por Localización_Centro revela una fuerte y clara disparidad en el coste que asume el estudiante, como se observa en el gráfico. El uso de la mediana para la comparación (en lugar de la media) es fundamental, ya que ofrece una medida de tendencia central robusta que no se ve afectada por los outliers de gasto extremo.

La gráfica muestra una jerarquía de gasto que parece estar directamente correlacionada con la distancia y la necesidad de alojamiento. El coste más elevado corresponde a los estudiantes que cursan en otra Comunidad Autonoma, con una mediana de gasto total de 6039€. Le sigue de cerca el gasto en la misma Comunidad Autónoma (4046€), lo que sugiere que el principal factor que impulsa la brecha económica es el coste asociado a vivir fuera del municipio de residencia (alquiler, manutención).

En el extremo opuesto, el gasto más bajo se da, como es lógico, en el Municipio Residencia (1690€), donde el estudiante no incurre en gastos de alojamiento y el transporte es mínimo. Es notable que estudiar en el Extranjero (2955€) representa un coste intermedio, significativamente más bajo que desplazarse a otra comunidad autónoma, lo que podría explicarse por la naturaleza de los programas de intercambio o becas asociadas.

Aquí tienes una propuesta de sección de conclusiones basada en los hallazgos detallados en tu informe ProyectoMDPI.Rmd.

# Conclusiones

El Análisis Exploratorio de Datos (AED) realizado sobre la Encuesta de Gasto de los Hogares en Educación (EGHE) de 2019 ha permitido diseccionar la estructura del gasto educativo en España, dando respuesta a las preguntas de investigación planteadas. Las conclusiones principales de este estudio son las siguientes:

- El gasto educativo está dominado por los servicios, no por los bienes. A nivel agregado, el 77.4% del desembolso total de los hogares se destina a servicios (matrículas, comedor, transporte, etc.), mientras que los bienes (libros, material) suponen el 22.6%. Esto desmitifica la idea de que los libros o el material son el principal componente del gasto.

- El tipo de centro es el factor más determinante del gasto. El análisis confirma una brecha inmensa: el gasto promedio en la enseñanza privada (superando los 4.500€) es más del doble que en la concertada (~2.000€) y más de cuatro veces superior al de la pública (~1.000€). Esta disparidad se explica casi en su totalidad por el coste de los servicios (tasas, matrículas y cuotas), que no están subvencionados en el caso de la privada.

- El gasto sigue un itinerario claro y creciente con la etapa educativa. El coste de la educación no es lineal. Se identifican dos picos de alto coste: el 1er Ciclo de Educación Infantil (etapa 0-3 años), cuyo gasto es elevado por la falta de subvención pública, y la Universidad, que representa el desembolso promedio más alto (3.056€). Las etapas de educación obligatoria (Primaria y ESO) son las que presentan un gasto más estable y contenido.

- Las características del hogar actúan como condicionantes claros. El gasto educativo no ocurre en el vacío. Este estudio confirma correlaciones estadísticamente significativas (p < 0.05) que indican que el gasto aumenta en municipios más grandes (rho=0.137) y en hogares con una mayor proporción de estudiantes (rho=0.274). Además, la localización del centro es crítica: estudiar fuera del municipio de residencia, y especialmente en otra Comunidad Autónoma (mediana > 6.000€), dispara el gasto por los costes de alojamiento.

En resumen, el gasto educativo en España es profundamente heterogéneo, segmentado por el eje público-privado y por la etapa educativa. El coste real para las familias no solo viene determinado por las tasas oficiales, sino por un ecosistema de gastos complementarios en servicios (comedor, informática, extraescolares) que suponen una carga económica considerable.