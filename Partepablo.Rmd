---
title: "Parte Pablo"
output: html_document
date: "2025-11-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Estudio relacionado con las variables relacionadas con el municipio

Primero vamos a ver la parte relacionada con TMUNI y LocalizaciónCentro
Como es un trbajo dedicacado al gasto en educación por hogar, vamos a agrupar primero todo por IDHOGAR. Después veremos el número total de cada tipo de municipio. Veremos también la relación con la localización del centro. Por último, veremos si existe una relación entre el tamaño del municipio y los gastos totales y lo mismo con la localización del centro.

```{r}
## Cuantos observables hay de cada tipo de municipio:
datos %>%
  count(TMUNI)

datos %>%
  count(Localización_Centro)

# Hay relación entre ambas????

tabla_rel_TMUNI_y_LocCen <- datos %>%
  select(TMUNI,Localización_Centro) %>%
  table()
tabla_rel_TMUNI_y_LocCen

chi2 <- chisq.test(tabla_rel_TMUNI_y_LocCen, correct= FALSE)
chi2

## Las variables TMUNI Y Localización_Centro son dependientes
```


```{r}
GastoMed_HogarxTMUNI <- datos %>% group_by(TMUNI) %>%
  summarise(Media_educación = mean(gasto_total_educacion), Media_servicios = mean(gasto_total_servicios), Media_servicios_reglados = mean(gasto_total_servicios_reglados), Media_servicios_noreglados = mean(gasto_total_servicios_no_reglados),Media_bienes = mean(gasto_total_bienes))
GastoMed_HogarxTMUNI

GastoMed_HogarxLocCen <- datos %>% group_by(Localización_Centro) %>%
  summarise(Media_educación = mean(gasto_total_educacion), Media_servicios = mean(gasto_total_servicios), Media_servicios_reglados = mean(gasto_total_servicios_reglados), Media_servicios_noreglados = mean(gasto_total_servicios_no_reglados),Media_bienes = mean(gasto_total_bienes))
GastoMed_HogarxLocCen
```


```{r}
## Detección outliers
GastosxTMUNI <- datos %>%
  select(TMUNI, gasto_total_educacion, gasto_total_servicios, gasto_total_servicios_reglados, gasto_total_servicios_no_reglados, gasto_total_bienes) %>%
  pivot_longer(cols = starts_with("gasto_total"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto")

Outlier_TMUNI <- GastosxTMUNI %>%
  group_by(Tipo_Gasto, TMUNI) %>%
  mutate(Q1 = quantile(Valor_Gasto, 0.25), Q3 = quantile(Valor_Gasto,0.75), IQR = IQR(Valor_Gasto), LimSup = Q3 + 1.5*IQR, LimInf = Q1 - 1.5*IQR) %>%
  filter(Valor_Gasto > LimSup | Valor_Gasto < LimInf) %>%
  ungroup() %>%
  arrange(Tipo_Gasto, TMUNI) %>%
  select(Tipo_Gasto, TMUNI, Valor_Gasto, LimInf, LimSup)
Outlier_TMUNI

```

```{r}
GastosxLocCen <- datos %>%
  select(Localización_Centro, gasto_total_educacion, gasto_total_servicios, gasto_total_servicios_reglados, gasto_total_servicios_no_reglados, gasto_total_bienes) %>%
  pivot_longer(cols = starts_with("gasto_total"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto")

Outlier_LocCen <- GastosxLocCen %>%
  group_by(Tipo_Gasto, Localización_Centro) %>%
  mutate(Q1 = quantile(Valor_Gasto, 0.25), Q3 = quantile(Valor_Gasto,0.75), IQR = IQR(Valor_Gasto), LimSup = Q3 + 1.5*IQR, LimInf = Q1 - 1.5*IQR) %>%
  filter(Valor_Gasto > LimSup | Valor_Gasto < LimInf) %>%
  ungroup() %>%
  arrange(Tipo_Gasto, Localización_Centro) %>%
  select(Tipo_Gasto, Localización_Centro, Valor_Gasto, LimInf, LimSup)
Outlier_LocCen
```


```{r}
## Representación gráfica 

GastosMedTMUNI <- GastoMed_HogarxTMUNI %>%
  pivot_longer(cols = starts_with("Media_"), names_to = "Tipo_Gasto", values_to = "Valor_Medio", names_prefix = "Media_")
head(GastosMedMUNI)

ggplot(GastosMedTMUNI, aes(x = TMUNI, y = Valor_Medio)) +
  geom_point(color = "blue", outlier.color = "red") +
  labs(title="Distribución Medias de Gasto por Tipo de Municipio", x= "Tipo de Municipio", y ="Media de Gasto") +
  facet_wrap(~Tipo_Gasto, ncol=2) +
  coord_flip() +
  theme_minimal()
```

```{r}
GastosMedLocCen <- GastoMedHogarxLocCen %>%
  pivot_longer(cols = starts_with("Media_"), names_to = "Tipo_Gasto", values_to = "Valor_Medio", names_prefix = "Media_")
head(GastosMedLocCen)

ggplot(GastosMedLocCen, aes(x = Localización_Centro, y = Valor_Medio)) +
  geom_point(color = "blue", outlier.color = "red") +
  labs(title="Distribución Medias de Gasto por Ubicación del Centro", x= "Ubicación del Centro", y ="Media de Gasto") +
  facet_wrap(~Tipo_Gasto, ncol = 2) +
  coord_flip() +
  theme_minimal()
```

Terminado el estudio de la relación entre la ubicación del estudiantes y su centro con el gasto total, nos centraremos ahora en el gasto total por hogar que es uno de los objetivos principales de este proyecto.

```{r}
datos_hogar <- datos %>%
  group_by(IDHOGAR) %>%
  summarise(TMUNI = first(TMUNI), NHOGAR = first(NHOGAR), EHOGAR = first(EHOGAR), Prop_Estudia = EHOGAR/NHOGAR, H_Gasto_Educación = sum(gasto_total_educacion), H_Gasto_Servicios = sum(gasto_total_servicios), H_Gasto_Servicios_Reglados = sum(gasto_total_servicios_reglados), H_Gasto_Servicios_NoReglados = sum(gasto_total_servicios_no_reglados), H_Gasto_Bienes = sum(gasto_total_bienes))
datos_hogar
```

Nos interesa estudiar la relación entre la proporción estudiantes/personas de un mismo hogar con los gastos totales.

```{r}
Prop_Hogar <- datos_hogar %>%
  select(IDHOGAR, Prop_Estudia, H_Gasto_Educación, H_Gasto_Servicios, H_Gasto_Servicios_Reglados, H_Gasto_Servicios_NoReglados, H_Gasto_Bienes) %>%
  pivot_longer(cols = starts_with("H_Gasto_"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto", names_prefix = "H_Gasto_")

head(Prop_Hogar)
  
```

```{r}
Prop_Hogar %>% ggplot(aes(x = Prop_Estudia, y = Valor_Gasto)) + 
  geom_point(alpha = 0.5, color = "green") + 
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  facet_wrap(~Tipo_Gasto, scales = "free_y", ncol = 3) +
  labs(title = "Relación Gastos Hogar y Proporción Estudiantes", x = "Proporción Estudiantes", y = "Gasto Total Hogar") +
  theme_minimal()
```

```{r}
Corr_rho_gasto_hogar <- Prop_Hogar %>%
  group_by(Tipo_Gasto) %>%
  summarise(corr_rho = cor(Prop_Estudia, Valor_Gasto, method = "spearman")) %>%
  arrange(desc(corr_rho))

corr_p_gasto_hogar <- Prop_Hogar %>%
  group_by(Tipo_Gasto) %>%
  summarise(p = cor.test(Prop_Estudia, Valor_Gasto, method = "spearman", exact = FALSE)$p.value) 

Corr_gasto_hogar <- left_join(Corr_rho_gasto_hogar, corr_p_gasto_hogar, by = "Tipo_Gasto") %>%
  arrange(desc(corr_rho))
Corr_gasto_hogar
```

```{r}
Prop_Hogar %>% ggplot(aes(x = Prop_Estudia, y =log(Valor_Gasto+1))) +
  geom_point(alpha = 0.5, color = "green") + 
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  facet_wrap(~Tipo_Gasto, ncol = 3, scales = "free_y") +
  labs(title = "Rel Gasto (Escala Log) y Prop Estudiantes", x = "Proporción Estudiantes", y = "Gasto del Hogar (Escala Logarítmica)") +
  theme_minimal()
```
Vamos ahora con el estudio de la relación entre el tamaño del municipio y los gastos totales.

```{r}
datos_muni <- datos_hogar %>%
  select(IDHOGAR, TMUNI, H_Gasto_Educación, H_Gasto_Servicios, H_Gasto_Servicios_Reglados, H_Gasto_Servicios_NoReglados, H_Gasto_Bienes) %>%
  pivot_longer(cols = starts_with("H_Gasto_"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto", names_prefix = "H_Gasto_")

head(datos_muni)
```

```{r}
datos_muni %>% ggplot(aes(x = TMUNI, y = log(Valor_Gasto +1))) + 
  geom_boxplot(aes(fill = TMUNI), show.legend = FALSE, outlier.color = "red") +
  facet_wrap(~Tipo_Gasto, scales = "free_x", ncol = 2) +
  coord_flip() +
  labs(title = "Relación Gastos Hogar y Tamaño del Municipio", x = "Tamaño del Municipio", y = "Gasto Total Hogar") +
  theme_minimal()
```
```{r}
outliers_TMUNI <- datos_muni %>%
  group_by(Tipo_Gasto, TMUNI) %>%
  mutate(Q1 = quantile(Valor_Gasto, 0.25), Q3 = quantile(Valor_Gasto,0.75), IQR = IQR(Valor_Gasto), LimSup = Q3 + 1.5*IQR, LimInf = Q1 - 1.5*IQR) %>%
  filter(Valor_Gasto > LimSup | Valor_Gasto < LimInf) %>%
  ungroup()

total_outliers_TMUNI <- outliers_TMUNI %>%
  count(TMUNI, sort = TRUE)
total_outliers_TMUNI
```

```{r}
Gasto_Total_TMUNI <- datos_muni %>%
  group_by(IDHOGAR, TMUNI) %>%
  summarise(GastoTotal = sum(Valor_Gasto))

cor_gasto_tmuni <- cor.test(as.numeric(Gasto_Total_TMUNI$TMUNI),Gasto_Total_TMUNI$GastoTotal, method = "spearman", exact = FALSE)

rho <- cor_gasto_tmuni$estimate
p <- cor_gasto_tmuni$p.value

rho
p
```

