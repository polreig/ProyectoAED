---
title: "Parte Pablo"
output: html_document
date: "2025-11-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Estudio relacionado con las variables relacionadas con el municipio

Primero vamos a ver la parte relacionada con TMUNI y LocalizaciónCentro
Como es un trbajo dedicacado al gasto en educación por hogar, vamos a agrupar primero todo por IDHOGAR. Después veremos el número total de cada tipo de municipio. Veremos también la relación con la localización del centro. Por último, veremos si existe una relación entre el tamaño del municipio y los gastos totales y lo mismo con la localización del centro.

```{r}
## Cuantos observables hay de cada tipo de municipio:
datos %>%
  count(TMUNI)

datos %>%
  count(Localización_Centro)

# Hay relación entre ambas????

tabla_rel_TMUNI_y_LocCen <- datos %>%
  select(TMUNI,Localización_Centro) %>%
  table()
tabla_rel_TMUNI_y_LocCen

chi2 <- chisq.test(tabla_rel_TMUNI_y_LocCen, correct= FALSE)
chi2

## Las variables TMUNI Y Localización_Centro son dependientes
```


```{r}
GastoMed_HogarxLocCen <- datos %>% group_by(Localización_Centro) %>%
  summarise(Media_educación = mean(gasto_total_educacion), Media_servicios = mean(gasto_total_servicios), Media_servicios_reglados = mean(gasto_total_servicios_reglados), Media_servicios_noreglados = mean(gasto_total_servicios_no_reglados),Media_bienes = mean(gasto_total_bienes))
GastoMed_HogarxLocCen
```


```{r}
## Detección outliers

GastosxLocCen <- datos %>%
  select(Localización_Centro, gasto_total_educacion, gasto_total_servicios, gasto_total_servicios_reglados, gasto_total_servicios_no_reglados, gasto_total_bienes) %>%
  pivot_longer(cols = starts_with("gasto_total"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto")

Outlier_LocCen <- GastosxLocCen %>%
  group_by(Tipo_Gasto, Localización_Centro) %>%
  mutate(Q1 = quantile(Valor_Gasto, 0.25), Q3 = quantile(Valor_Gasto,0.75), IQR = IQR(Valor_Gasto), LimSup = Q3 + 1.5*IQR, LimInf = Q1 - 1.5*IQR) %>%
  filter(Valor_Gasto > LimSup | Valor_Gasto < LimInf) %>%
  ungroup() %>%
  arrange(Tipo_Gasto, Localización_Centro) %>%
  select(Tipo_Gasto, Localización_Centro, Valor_Gasto, LimInf, LimSup)
Outlier_LocCen

```


```{r}
## Representación gráfica 

GastosMedLocCen <- GastoMed_HogarxLocCen %>%
  pivot_longer(cols = starts_with("Media_"), names_to = "Tipo_Gasto", values_to = "Valor_Medio", names_prefix = "Media_")
head(GastosMedLocCen)

ggplot(GastosMedLocCen, aes(x = Localización_Centro, y = Valor_Medio)) +
  geom_point(color = "blue") +
  labs(title="Distribución Medias de Gasto por Ubicación del Centro", x= "Ubicación del Centro", y ="Media de Gasto") +
  facet_wrap(~Tipo_Gasto, ncol = 2) +
  coord_flip() +
  theme_minimal()
```

Terminado el estudio de la relación entre la ubicación del estudiantes y su centro con el gasto total, nos centraremos ahora en el gasto total por hogar que es uno de los objetivos principales de este proyecto.

```{r}
datos_hogar <- datos %>%
  group_by(IDHOGAR) %>%
  summarise(TMUNI = first(TMUNI), NHOGAR = first(NHOGAR), EHOGAR = first(EHOGAR), Prop_Estudia = (EHOGAR/NHOGAR)*100, H_Gasto_Educación = sum(gasto_total_educacion), H_Gasto_Servicios = sum(gasto_total_servicios), H_Gasto_Servicios_Reglados = sum(gasto_total_servicios_reglados), H_Gasto_Servicios_NoReglados = sum(gasto_total_servicios_no_reglados), H_Gasto_Bienes = sum(gasto_total_bienes)) 

datos_hogar$Prop_Estudia <- signif(datos_hogar$Prop_Estudia, digits = 4)

head(datos_hogar)

```

Nos interesa estudiar la relación entre la proporción estudiantes/personas de un mismo hogar con los gastos totales.

```{r}
Prop_Hogar <- datos_hogar %>%
  select(IDHOGAR, Prop_Estudia, H_Gasto_Educación, H_Gasto_Servicios, H_Gasto_Servicios_Reglados, H_Gasto_Servicios_NoReglados, H_Gasto_Bienes) %>%
  pivot_longer(cols = starts_with("H_Gasto_"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto", names_prefix = "H_Gasto_")  
head(Prop_Hogar)
  
```

```{r}
datos_hogar_porcentaje <- Prop_Hogar %>%
  mutate(Grupo_Proporción = cut(Prop_Estudia, breaks= c(-0.1, 20, 40, 60, 80, 100), labels = c("0-20%", "21-40%", "41-60%", "61-80%", "81-100%"), include.lowest = TRUE)) 
datos_hogar_porcentaje
```

```{r}
datos_hogar_porcentaje %>% ggplot(aes(x = Grupo_Proporción, y = log(Valor_Gasto+1))) +
  geom_boxplot(aes(fill = Grupo_Proporción), show.legend = FALSE, outlier.colour = "red") + 
  facet_wrap(~Tipo_Gasto, scales="free_x", ncol = 3) +
  coord_flip() +
  labs(title = "Gastos Hogar (Log) por Prop. Estudiantes ", x = "Grupo de Proporción de Estudiantes", y = "Log(Gastos Totales del Hogar + 1)") 
  
```
```{r}
Medianas_gasto <- datos_hogar_porcentaje %>%
  group_by(Grupo_Proporción, Tipo_Gasto) %>%
  summarise(Mediana_Gasto = median(Valor_Gasto), .groups = "drop")

max_mediana <- Medianas_gasto %>%
  group_by(Grupo_Proporción) %>%
  slice_max(order_by = Mediana_Gasto, n=1) %>%
  ungroup()
max_mediana
```
```{r}
Gasto_Total_PropEst <- datos_hogar_porcentaje %>%
  group_by(IDHOGAR, Grupo_Proporción) %>%
  summarise(Gasto_Total = sum(Valor_Gasto), .groups = "drop") 
  
  

cor_gasto_prop <- cor.test(as.numeric(Gasto_Total_PropEst$Grupo_Proporción), Gasto_Total_PropEst$Gasto_Total, method = "spearman", exact = FALSE)

rho <- cor_gasto_prop$estimate
p <- cor_gasto_prop$p.value

rho
p
```


Vamos ahora con el estudio de la relación entre el tamaño del municipio y los gastos totales.

```{r}
datos_muni <- datos_hogar %>%
  select(IDHOGAR, TMUNI, H_Gasto_Educación, H_Gasto_Servicios, H_Gasto_Servicios_Reglados, H_Gasto_Servicios_NoReglados, H_Gasto_Bienes) %>%
  pivot_longer(cols = starts_with("H_Gasto_"), names_to = "Tipo_Gasto", values_to = "Valor_Gasto", names_prefix = "H_Gasto_")

head(datos_muni)
```

```{r}
datos_muni %>% ggplot(aes(x = TMUNI, y = log(Valor_Gasto +1))) + 
  geom_boxplot(aes(fill = TMUNI), show.legend = FALSE, outlier.color = "red") +
  facet_wrap(~Tipo_Gasto, scales = "free_x", ncol = 2) +
  coord_flip() +
  labs(title = "Relación Gastos Hogar y Tamaño del Municipio", x = "Tamaño del Municipio", y = "Gasto Total Hogar") +
  theme_minimal()
```
```{r}
outliers_TMUNI <- datos_muni %>%
  group_by(Tipo_Gasto, TMUNI) %>%
  mutate(Q1 = quantile(Valor_Gasto, 0.25), Q3 = quantile(Valor_Gasto,0.75), IQR = IQR(Valor_Gasto), LimSup = Q3 + 1.5*IQR, LimInf = Q1 - 1.5*IQR) %>%
  filter(Valor_Gasto > LimSup | Valor_Gasto < LimInf) %>%
  ungroup()

total_outliers_TMUNI <- outliers_TMUNI %>%
  count(TMUNI, sort = TRUE)
total_outliers_TMUNI
```

```{r}
Gasto_Total_TMUNI <- datos_muni %>%
  group_by(IDHOGAR, TMUNI) %>%
  summarise(GastoTotal = sum(Valor_Gasto), .groups = "drop") 
  
  

cor_gasto_tmuni <- cor.test(as.numeric(Gasto_Total_TMUNI$TMUNI),Gasto_Total_TMUNI$GastoTotal, method = "spearman", exact = FALSE)

rho <- cor_gasto_tmuni$estimate
p <- cor_gasto_tmuni$p.value

rho
p
```

```{r}
# 1. Calcular las medianas para TMUNI
Medianas_gasto_TMUNI <- datos_muni %>% # Usando tu data frame largo
  group_by(TMUNI, Tipo_Gasto) %>%
  summarise(Mediana_Gasto = median(Valor_Gasto, na.rm = TRUE), .groups = "drop")

# 2. Encontrar el gasto MÁXIMO para cada TMUNI
max_mediana_TMUNI <- Medianas_gasto_TMUNI %>%
  group_by(TMUNI) %>%
  slice_max(order_by = Mediana_Gasto, n = 1) %>%
  ungroup()

# 3. Ver los resultados
print(max_mediana_TMUNI)
```

